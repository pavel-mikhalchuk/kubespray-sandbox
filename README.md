# kubespray

## Перед началом запуска

0. Тебе просто необходимо немного ознакомится с Ansible (https://www.ansible.com/resources/get-started), чтобы научится читать структуру и имена папок и файлов этого проекта.

1. Набор виртуалок с установленной Ubuntu 18.04.

1. SSH ключи того пользователя, который запускает kubespray должны быть скопированы на все виртуалки. Это необходимо kubespray для безпарольного доступа к ним. Пользователь должен иметь root права на каждой машине. В случае, если сис админы не обеспечили безпарольный доступ для пользователя, который запускает kubespray, но есть парольный доступ,то нужно сгенерировать SSH ключи и скопировать их на все виртуалки. Тогда появится безпарольный доступ. Смотри README.MD в папке ssh-utils/keys. Еще очень важно, чтобы на виртуалках твой пользователь мог стать рутом (через sudo su, например) без ввода пароля. Если необходимо вводить пароль, то Ansible завалится. Об этом опять же должны позаботиться админы перед тем, как отдавать тебе виртуалки. Но если и тут косяк тогда гугли как сделать пользователя рутом без пароля (https://askubuntu.com/questions/147241/execute-sudo-without-password).

   > Open terminal window and type:
   >
   > `sudo visudo`
   >
   > In the bottom of the file, type the follow:
   >
   > `$USER ALL=(ALL) NOPASSWD: ALL`

## IP адреса виртуалок

В корневой папке проекта есть файл `hosts.ini`, в котором надо указать ip адреса всех виртуалок. Так указать кто мастер и кто воркер.

## Запуск деплоймента kubernetes кластера

1. Для того, чтобы запустить kubespray мы будем использовать docker образ, созданный на базе файлика `Dockerfile_kubespray`. (**На момент 9.02.2019 я [Павел Михальчук] планирую сделать этот образ доступным для использования в нашем приватном docker registry. Поэтому перед тем как собирать docker образ самостоятельно проверь нет ли уже его в нашем docker registry. Но если же ты сам делаешь изменения в этом репозитории, которые могут затронуть Dockerfile_kubespray, тогда тебе точно надо собирать его руками.**).

   Собираем docker образ:

   > `docker build -t kubespray -f Dockerfile_kubespray.`

2. Запускаем kubespray:

   Полагаем, что:

   - Админы создали нам на каждой виртуалке пользователя **infra**.
   - У тебя есть ssh ключи для безпарольного доступа пользователя **infra** на все виртуалки. Ключи находятся на твоей машине тут - `/home/infra/.ssh/`.
   - На всех виртуалках пользователь **infra** может стать root без введения пароля.<br/><br/>
   
   > `docker run --rm -e "USER=infra" -v /home/infra/.ssh/:/host_ssh kubespray ansible-playbook --become --become-user=root master_playbook.yml`

   Пояснения:

   > `-e "USER=infra"` - мы запускаем kubespray от лица пользователя **infra**

   > `-v /home/infra/.ssh/:/host_ssh` - указываем путь к ssh ключам пользователя **infra** на твоей машине. `/host_ssh` используется в `scripts/kubespray-entrypoint.sh`.

   > `--become --become-user=root` - это настройки Ansible для того, чтобы стать рутом на виртуалках.
