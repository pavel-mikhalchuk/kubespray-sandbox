- name: Check kube config in user home
  stat:
    path: ~/.kube/config
  register: kube_config_in_home

- name: Check kube config in ansible artifact dir
  stat:
    path: "/kubespray/artifacts/admin.conf"
  register: kube_config_in_ansible

- debug:
    var: kube_config_in_home

- debug:
    var: kube_config_in_ansible

- fail:
    msg: "Kube config is not found in both '~/.kube/config' and {{ artifacts_dir }}"
  when: (kube_config_in_home.stat.exists == False and kube_config_in_ansible.stat.exists == False)

- file:
    src: "{{ kube_config_in_ansible }}"
    dest: "{{ kube_config_in_home }}"
  when: kube_config_in_home.stat.exists == False

- name: Get helm tiller status
  k8s_facts:
    kind: Deployment
    label_selectors:
      - app = helm
      - name = tiller
    namespace: kube-system
  register: tiller

- name: Install helm tiller
  import_tasks: helm-tiller.yml
  vars:
    tiller_state: present
  when: tiller.resources | length == 0
